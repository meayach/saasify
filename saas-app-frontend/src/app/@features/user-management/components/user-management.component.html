<div class="subscription-dashboard-container">
  <!-- Global header (logo + user dropdown) -->
  <div
    style="
      position: sticky;
      top: 0;
      z-index: 1000;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 16px 24px;
    ">
    <div style="display: flex; justify-content: space-between; align-items: center">
      <div style="display: flex; align-items: center; gap: 16px">
        <a (click)="router.navigate(['/dashboard'])" style="display: inline-block; cursor: pointer">
          <img src="assets/logo-saasify.svg" alt="Saasify Logo" style="height: 40px" />
        </a>
      </div>
      <div style="position: relative">
        <button
          (click)="toggleDropdown()"
          style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
          ">
          <div
            style="
              width: 32px;
              height: 32px;
              background: rgba(255, 255, 255, 0.2);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
            ">
            <span style="color: white; font-weight: bold; font-size: 18px">{{
              (userName || 'U').charAt(0).toUpperCase()
            }}</span>
          </div>
          <div>
            <div style="font-size: 13px; line-height: 1.2">{{ userName || 'Utilisateur' }}</div>
            <div style="font-size: 11px; opacity: 0.8">{{ userRole }}</div>
          </div>
          <span
            style="margin-left: 8px; transition: transform 0.3s ease"
            [style.transform]="isDropdownOpen ? 'rotate(180deg)' : 'rotate(0deg)'">
            ▼
          </span>
        </button>

        <div
          *ngIf="isDropdownOpen"
          style="
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 200px;
            margin-top: 8px;
            z-index: 1000;
            border: 1px solid #e2e8f0;
          ">
          <div style="padding: 12px 16px; border-bottom: 1px solid #f1f5f9">
            <div style="font-weight: 600; color: #1a202c; font-size: 14px">
              {{ userName || 'Utilisateur' }}
            </div>
            <div style="color: #64748b; font-size: 12px">{{ userEmail }}</div>
          </div>
          <button
            (click)="setActiveProfileSection('edit')"
            style="
              display: block;
              width: 100%;
              padding: 12px 16px;
              color: #374151;
              background: transparent;
              border: none;
              text-align: left;
              cursor: pointer;
              transition: background-color 0.2s;
            "
            onmouseover="this.style.backgroundColor='#f8fafc'"
            onmouseout="this.style.backgroundColor='transparent'">
            Modifier le profil
          </button>
          <button
            (click)="setActiveProfileSection('password')"
            style="
              display: block;
              width: 100%;
              padding: 12px 16px;
              color: #374151;
              background: transparent;
              border: none;
              text-align: left;
              cursor: pointer;
              transition: background-color 0.2s;
            "
            onmouseover="this.style.backgroundColor='#f8fafc'"
            onmouseout="this.style.backgroundColor='transparent'">
            Changer le mot de passe
          </button>
          <div style="border-top: 1px solid #f1f5f9; margin-top: 8px"></div>
          <button
            (click)="logout()"
            style="
              display: block;
              width: 100%;
              padding: 12px 16px;
              color: #ef4444;
              background: transparent;
              border: none;
              text-align: left;
              cursor: pointer;
              transition: background-color 0.2s;
            "
            onmouseover="this.style.backgroundColor='#fef2f2'"
            onmouseout="this.style.backgroundColor='transparent'">
            Déconnexion
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenu principal -->
  <div class="container">
    <div class="header-section">
      <h1>Gestion des utilisateurs</h1>
      <p class="subtitle">Gérez tous les utilisateurs de votre organisation</p>
    </div>

    <!-- Actions et filtres -->
    <div class="actions-section">
      <div class="filters">
        <div class="search-bar">
          <input
            type="text"
            placeholder="Rechercher un utilisateur..."
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()"
            class="search-input" />
        </div>

        <select [(ngModel)]="selectedRole" (change)="onRoleFilterChange()" class="filter-select">
          <option value="">Tous les rôles</option>
          <option *ngFor="let role of roles" [value]="role.value">{{ role.label }}</option>
        </select>
      </div>

      <button (click)="openCreateUserModal()" class="btn-primary">
        <i class="pi pi-plus"></i>
        Nouvel utilisateur
      </button>
    </div>

    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner">
        <i class="pi pi-spinner pi-spin"></i>
        <p>Chargement des utilisateurs...</p>
      </div>
    </div>

    <!-- Table des utilisateurs -->
    <div *ngIf="!isLoading" class="users-table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>Utilisateur</th>
            <th>Email</th>
            <th>Rôle</th>
            <th>Téléphone</th>
            <th>Date création</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of getPaginatedUsers()">
            <td>
              <div class="user-info">
                <div class="user-avatar">
                  {{ getUserInitials(user) }}
                </div>
                <div class="user-details">
                  <div class="user-name">{{ user.firstName }} {{ user.lastName }}</div>
                  <div class="user-id">ID: {{ user._id?.substring(0, 8) }}...</div>
                </div>
              </div>
            </td>
            <td>{{ user.email }}</td>
            <td>
              <span class="role-badge" [class]="'role-' + user.role">
                {{ getRoleLabel(user.role) }}
              </span>
            </td>
            <td>{{ user.phoneNumber || '-' }}</td>
            <td>{{ formatDate(user.createdAt) }}</td>
            <td>
              <div class="actions-menu">
                <button
                  (click)="openEditUserModal(user)"
                  class="action-btn edit-btn"
                  title="Modifier">
                  <i class="pi pi-pencil"></i>
                </button>
                <button
                  (click)="toggleUserStatus(user)"
                  class="action-btn"
                  [class]="user.status === 'ACTIVE' ? 'deactivate-btn' : 'activate-btn'"
                  [title]="user.status === 'ACTIVE' ? 'Désactiver' : 'Activer'">
                  <i [class]="user.status === 'ACTIVE' ? 'pi pi-eye-slash' : 'pi pi-eye'"></i>
                </button>
                <button
                  (click)="resetPassword(user)"
                  class="action-btn reset-btn"
                  title="Réinitialiser le mot de passe">
                  <i class="pi pi-key"></i>
                </button>
                <button
                  (click)="openDeleteModal(user)"
                  class="action-btn delete-btn"
                  title="Supprimer">
                  <i class="pi pi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Message si aucun utilisateur -->
      <div *ngIf="filteredUsers.length === 0" class="no-users">
        <i class="pi pi-users"></i>
        <h3>Aucun utilisateur trouvé</h3>
        <p>Aucun utilisateur ne correspond à vos critères de recherche.</p>
      </div>
    </div>

    <!-- Pagination -->
    <div *ngIf="totalPages > 1" class="pagination">
      <button (click)="previousPage()" [disabled]="currentPage === 1" class="pagination-btn">
        <i class="pi pi-chevron-left"></i>
      </button>

      <span class="pagination-info"> Page {{ currentPage }} sur {{ totalPages }} </span>

      <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="pagination-btn">
        <i class="pi pi-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Modal de création/édition d'utilisateur -->
  <div *ngIf="showUserModal" class="modal-overlay" (click)="closeUserModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditMode ? "Modifier l'utilisateur" : 'Nouvel utilisateur' }}</h3>
        <button (click)="closeUserModal()" class="close-btn">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="user-form">
        <div class="form-row">
          <div class="form-group">
            <label for="firstName">Prénom *</label>
            <input type="text" id="firstName" formControlName="firstName" class="form-input" />
          </div>
          <div class="form-group">
            <label for="lastName">Nom *</label>
            <input type="text" id="lastName" formControlName="lastName" class="form-input" />
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email *</label>
          <input
            type="email"
            id="email"
            formControlName="email"
            class="form-input"
            [readonly]="isEditMode" />
        </div>

        <div *ngIf="!isEditMode" class="form-group">
          <label for="password">Mot de passe *</label>
          <input type="password" id="password" formControlName="password" class="form-input" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="role">Rôle *</label>
            <select id="role" formControlName="role" class="form-select">
              <option *ngFor="let role of roles" [value]="role.value">{{ role.label }}</option>
            </select>
          </div>
          <div class="form-group">
            <label for="phoneNumber">Téléphone</label>
            <input type="tel" id="phoneNumber" formControlName="phoneNumber" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="streetAddress">Adresse</label>
            <input
              type="text"
              id="streetAddress"
              formControlName="streetAddress"
              class="form-input" />
          </div>
          <div class="form-group">
            <label for="city">Ville</label>
            <input type="text" id="city" formControlName="city" class="form-input" />
          </div>
        </div>

        <div class="form-group">
          <label for="zipCode">Code postal</label>
          <input type="text" id="zipCode" formControlName="zipCode" class="form-input" />
        </div>

        <div class="modal-actions">
          <button type="button" (click)="closeUserModal()" class="btn-secondary">Annuler</button>
          <button type="submit" [disabled]="userForm.invalid" class="btn-primary">
            {{ isEditMode ? 'Modifier' : 'Créer' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirmation de suppression -->
  <div *ngIf="showDeleteModal" class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmer la suppression</h3>
        <button (click)="closeDeleteModal()" class="close-btn">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <p>
          Êtes-vous sûr de vouloir supprimer l'utilisateur
          <strong>{{ userToDelete?.firstName }} {{ userToDelete?.lastName }}</strong> ?
        </p>
        <p class="warning-text">Cette action est irréversible.</p>
      </div>

      <div class="modal-actions">
        <button type="button" (click)="closeDeleteModal()" class="btn-secondary">Annuler</button>
        <button type="button" (click)="confirmDelete()" class="btn-danger">Supprimer</button>
      </div>
    </div>
  </div>
</div>

<div class="subscription-dashboard-container">
  <!-- Global header (logo + user dropdown) -->
  <div class="sticky-header">
    <div class="header-content">
      <div class="logo-section">
        <a (click)="router.navigate(['/dashboard'])" class="logo-link">
          <img src="assets/logo-saasify.svg" alt="Saasify Logo" class="logo-img" />
        </a>
      </div>
      <div class="user-dropdown-container">
        <button (click)="toggleDropdown()" class="user-dropdown-button">
          <div class="user-avatar">
            <span class="user-avatar-text">{{ (userName || 'U').charAt(0).toUpperCase() }}</span>
          </div>
          <div class="user-info">
            <div class="user-name">{{ userName || 'Utilisateur' }}</div>
            <div class="user-role">{{ userRole }}</div>
          </div>
          <span class="dropdown-arrow" [class.open]="isDropdownOpen">▼</span>
        </button>

        <div *ngIf="isDropdownOpen" class="dropdown-menu">
          <div class="dropdown-user-info">
            <div class="dropdown-user-name">{{ userName || 'Utilisateur' }}</div>
            <div class="dropdown-user-email">{{ userEmail }}</div>
          </div>
          <button (click)="setActiveProfileSection('edit')" class="dropdown-menu-item">
            Modifier le profil
          </button>
          <button (click)="setActiveProfileSection('password')" class="dropdown-menu-item">
            Changer le mot de passe
          </button>
          <div class="dropdown-separator"></div>
          <button (click)="logout()" class="dropdown-menu-item danger">Déconnexion</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Page Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">Gestion des abonnements</h1>
    <p class="dashboard-subtitle">Gérez vos abonnements, offres et informations de facturation</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Chargement de vos abonnements...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-container">
    <p class="error-message">{{ error }}</p>
    <button (click)="loadSubscriptions()" class="retry-button">Réessayer</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading && !error" class="dashboard-content">
    <!-- Carte d'abonnement actuel -->
    <div *ngIf="currentSubscription" class="current-subscription-card">
      <div class="card-header">
        <h2 class="card-title">Abonnement actuel</h2>
        <span class="status-badge" [class]="getStatusColor(currentSubscription.status)">
          {{ formatStatus(currentSubscription.status) }}
        </span>
      </div>

      <div class="subscription-details">
        <div class="plan-info">
          <h3 class="plan-name">{{ currentSubscription.planId.name }}</h3>
          <p class="plan-description">{{ currentSubscription.planId.description }}</p>
          <div class="plan-price">
            <span class="price">${{ currentSubscription.price }}</span>
            <span class="billing-cycle"
              >/ {{ currentSubscription.billingCycle.toLowerCase() }}</span
            >
          </div>
        </div>

        <!-- Avertissement période d'essai -->
        <div *ngIf="isTrialExpiringSoon(currentSubscription)" class="trial-warning">
          <div class="warning-icon">⏰</div>
          <div class="warning-content">
            <h4>Période d'essai bientôt terminée&nbsp;!</h4>
            <p>
              Votre période d'essai se termine le
              {{ formatDate(currentSubscription.trialEndDate) }}.
              <a (click)="navigateToPlans()" class="upgrade-link">Passez à une offre</a> pour
              continuer à utiliser nos services.
            </p>
          </div>
        </div>

        <!-- Prochaine facturation -->
        <div
          *ngIf="currentSubscription.nextBillingDate && currentSubscription.status === 'ACTIVE'"
          class="next-billing">
          <p>Prochaine facturation&nbsp;: {{ formatDate(currentSubscription.nextBillingDate) }}</p>
          <p class="days-until">{{ getDaysUntilBilling(currentSubscription) }} jours restants</p>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button (click)="navigateToDetails(currentSubscription._id)" class="btn btn-primary">
            Voir les détails
          </button>
          <button (click)="navigateToPlans()" class="btn btn-secondary">Changer de forfait</button>
          <button
            *ngIf="currentSubscription.status === 'ACTIVE'"
            (click)="cancelSubscription(currentSubscription)"
            class="btn btn-danger">
            Annuler l'abonnement
          </button>
        </div>
      </div>
    </div>

    <!-- Aucun abonnement actif -->
    <div *ngIf="!currentSubscription" class="no-subscription-card">
      <div class="no-subscription-content">
        <h2>Aucun abonnement actif</h2>
        <p>Vous n'avez pas d'abonnement actif. Choisissez une offre pour commencer&nbsp;!</p>
        <button (click)="navigateToPlans()" class="btn btn-primary btn-large">
          Voir les offres disponibles
        </button>
      </div>

      <!-- Offres rapides -->
      <div class="quick-subscribe-section">
        <h3>Abonnez-vous rapidement</h3>
        <div class="plans-grid">
          <div class="plan-quick-card" *ngFor="let plan of availablePlans">
            <div class="plan-header">
              <h4>{{ plan.name }}</h4>
              <div class="plan-price-quick">
                <span class="price">${{ plan.price }}</span>
                <span class="period">/mois</span>
              </div>
            </div>
            <p class="plan-description">{{ plan.description }}</p>
            <ul class="features-list" *ngIf="plan.features">
              <li *ngFor="let feature of plan.features">{{ feature }}</li>
            </ul>
            <button (click)="createSubscription(plan._id)" class="btn btn-outline btn-full-width">
              S'abonner maintenant
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <h3 class="section-title">Actions rapides</h3>
      <div class="action-grid">
        <div class="action-card" (click)="navigateToPlans()">
          <h4>Parcourir les offres</h4>
          <p>Découvrez les offres d'abonnement disponibles</p>
        </div>

        <div class="action-card" (click)="navigateToPaymentMethods()">
          <h4>Moyens de paiement</h4>
          <p>Gérez vos moyens de paiement</p>
        </div>

        <div class="action-card" (click)="navigateToBillingHistory()">
          <h4>Historique de facturation</h4>
          <p>Consultez l'historique de vos paiements</p>
        </div>
      </div>
    </div>

    <!-- Tous les abonnements -->
    <div *ngIf="subscriptions.length > 0" class="all-subscriptions">
      <h3 class="section-title">Tous les abonnements</h3>
      <div class="subscriptions-table">
        <div class="table-header">
          <div class="col-plan">Offre</div>
          <div class="col-status">Statut</div>
          <div class="col-price">Prix</div>
          <div class="col-date">Date de début</div>
          <div class="col-actions">Actions</div>
        </div>

        <div *ngFor="let subscription of subscriptions" class="table-row">
          <div class="col-plan">
            <div class="plan-cell">
              <strong>{{ subscription.planId.name }}</strong>
              <small>{{ subscription.planId.type }}</small>
            </div>
          </div>
          <div class="col-status">
            <span class="status-badge" [class]="getStatusColor(subscription.status)">
              {{ formatStatus(subscription.status) }}
            </span>
          </div>
          <div class="col-price">
            ${{ subscription.price }} / {{ subscription.billingCycle.toLowerCase() }}
          </div>
          <div class="col-date">
            {{ formatDate(subscription.startDate) }}
          </div>
          <div class="col-actions">
            <button (click)="navigateToDetails(subscription._id)" class="btn btn-sm btn-outline">
              Détails
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="loading-container">
  <div class="loading-spinner"></div>
  <p>Chargement des fonctionnalités...</p>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="error-container">
  <div class="error-icon">⚠️</div>
  <p>{{ error }}</p>
  <button class="retry-button" (click)="refresh()">Réessayer</button>
</div>

<!-- Feature Configuration Form -->
<div *ngIf="!loading && !error" class="features-edit-container" [class.compact-mode]="compactMode">
  <!-- Toolbar -->
  <div class="features-toolbar">
    <div class="search-section">
      <input
        type="text"
        class="search-input"
        placeholder="Rechercher une fonctionnalité..."
        [(ngModel)]="searchTerm" />
      <select class="category-filter" [(ngModel)]="selectedCategory">
        <option value="all">Toutes les catégories</option>
        <option *ngFor="let category of getFeatureCategories()" [value]="category">
          {{ getCategoryLabel(category) }}
        </option>
      </select>
    </div>

    <div class="toolbar-actions" *ngIf="!readonly">
      <button type="button" class="btn btn-secondary" (click)="resetForm()">Réinitialiser</button>
    </div>
  </div>

  <!-- Form -->
  <form [formGroup]="form" class="features-form">
    <div formArrayName="features">
      <!-- Category-based display -->
      <div *ngIf="showCategories" class="features-by-category">
        <div *ngFor="let category of getFeatureCategories()" class="category-section">
          <!-- Category Header -->
          <div class="category-header" (click)="toggleCategory(category)">
            <h3 class="category-title">
              <span class="category-icon">{{ getDefaultIcon(category) }}</span>
              {{ getCategoryLabel(category) }}
              <span class="feature-count">({{ getFeaturesForCategory(category).length }})</span>
            </h3>
            <span class="expand-icon" [class.expanded]="isCategoryExpanded(category)">▼</span>
          </div>

          <!-- Category Features -->
          <div class="category-content" [class.expanded]="isCategoryExpanded(category)">
            <div
              *ngFor="let feature of getFeaturesForCategory(category); let featureIndex = index"
              class="feature-config-item">
              <div [formGroupName]="featureIndex" class="feature-form-group">
                <!-- Feature Header -->
                <div class="feature-config-header">
                  <div class="feature-info">
                    <div class="feature-icon">{{ getFeatureIcon(feature) }}</div>
                    <div class="feature-details">
                      <h4 class="feature-name">{{ feature.name }}</h4>
                      <p class="feature-description">{{ feature.description }}</p>
                    </div>
                  </div>

                  <!-- Status Toggle -->
                  <div class="feature-status-section" *ngIf="!readonly">
                    <label class="status-label">Statut:</label>
                    <select formControlName="status" class="status-select">
                      <option
                        *ngFor="
                          let status of [
                            FeatureStatus.INACTIVE,
                            FeatureStatus.ACTIVE,
                            FeatureStatus.LIMITED,
                            FeatureStatus.COMING_SOON
                          ]
                        "
                        [value]="status">
                        {{ getStatusLabel(status) }}
                      </option>
                    </select>
                  </div>

                  <!-- Read-only Status -->
                  <div class="feature-status-readonly" *ngIf="readonly">
                    <span
                      class="status-badge"
                      [class]="
                        getStatusClass(getFeatureFormGroup(featureIndex).get('status')?.value)
                      ">
                      {{ getStatusLabel(getFeatureFormGroup(featureIndex).get('status')?.value) }}
                    </span>
                  </div>
                </div>

                <!-- Feature Configuration (shown when active) -->
                <div
                  class="feature-config-content"
                  *ngIf="isFeatureActive(featureIndex)"
                  [@slideDown]>
                  <!-- Priority Setting -->
                  <div class="config-row" *ngIf="!readonly">
                    <label class="config-label">Priorité (0-100):</label>
                    <input
                      type="number"
                      formControlName="priority"
                      class="config-input priority-input"
                      min="0"
                      max="100" />
                  </div>

                  <!-- Custom Fields -->
                  <div
                    class="custom-fields-section"
                    formArrayName="customFields"
                    *ngIf="feature.customFields.length > 0">
                    <h5 class="section-title">Configuration</h5>

                    <div
                      *ngFor="let field of feature.customFields; let fieldIndex = index"
                      class="custom-field-item"
                      [formGroupName]="fieldIndex">
                      <div class="field-header">
                        <label class="field-label">
                          {{ field.displayName || field.fieldName }}
                          <span class="required-indicator" *ngIf="isFieldRequired(field)">*</span>
                        </label>
                        <span class="field-type">{{ getFieldTypeLabel(field.fieldType) }}</span>
                      </div>

                      <div class="field-description" *ngIf="field.description">
                        <small>{{ field.description }}</small>
                      </div>

                      <!-- Text Field -->
                      <input
                        *ngIf="field.fieldType === FieldType.TEXT"
                        type="text"
                        formControlName="value"
                        class="field-input"
                        [placeholder]="field.defaultValue"
                        [readonly]="readonly" />

                      <!-- Number Field -->
                      <input
                        *ngIf="field.fieldType === FieldType.NUMBER"
                        type="number"
                        formControlName="value"
                        class="field-input"
                        [placeholder]="field.defaultValue"
                        [min]="field.validation?.min"
                        [max]="field.validation?.max"
                        [readonly]="readonly" />

                      <!-- Email Field -->
                      <input
                        *ngIf="field.fieldType === FieldType.EMAIL"
                        type="email"
                        formControlName="value"
                        class="field-input"
                        [placeholder]="field.defaultValue"
                        [readonly]="readonly" />

                      <!-- URL Field -->
                      <input
                        *ngIf="field.fieldType === FieldType.URL"
                        type="url"
                        formControlName="value"
                        class="field-input"
                        [placeholder]="field.defaultValue"
                        [readonly]="readonly" />

                      <!-- Boolean Field -->
                      <div *ngIf="field.fieldType === FieldType.BOOLEAN" class="boolean-field">
                        <label class="checkbox-label">
                          <input type="checkbox" formControlName="value" [disabled]="readonly" />
                          <span class="checkbox-text">{{
                            field.description || 'Activer cette option'
                          }}</span>
                        </label>
                      </div>

                      <!-- JSON Field -->
                      <textarea
                        *ngIf="field.fieldType === FieldType.JSON"
                        formControlName="value"
                        class="field-input json-field"
                        [placeholder]="field.defaultValue"
                        rows="4"
                        [readonly]="readonly"></textarea>

                      <!-- Field Validation Error -->
                      <div
                        class="field-error"
                        *ngIf="getFieldValidationError(featureIndex, fieldIndex)">
                        {{ getFieldValidationError(featureIndex, fieldIndex) }}
                      </div>

                      <!-- Field Help Text -->
                      <div class="field-help" *ngIf="field.validation?.helpText">
                        <small>{{ field.validation.helpText }}</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Flat display (no categories) -->
      <div *ngIf="!showCategories" class="features-flat">
        <div
          *ngFor="let feature of getFilteredFeatures(); let featureIndex = index"
          class="feature-config-item">
          <!-- Same content as category-based display -->
          <!-- ... (repeat the feature form content) ... -->
        </div>
      </div>
    </div>
  </form>

  <!-- Form Status -->
  <div class="form-status" *ngIf="!readonly">
    <div
      class="status-indicator"
      [class.valid]="form.valid"
      [class.invalid]="form.invalid && form.touched">
      <span *ngIf="form.valid" class="status-text valid">✓ Configuration valide</span>
      <span *ngIf="form.invalid && form.touched" class="status-text invalid"
        >⚠ Erreurs dans la configuration</span
      >
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions" *ngIf="!readonly">
    <button type="button" class="quick-action-btn" (click)="setAllFeatures(FeatureStatus.ACTIVE)">
      Activer toutes
    </button>
    <button type="button" class="quick-action-btn" (click)="setAllFeatures(FeatureStatus.INACTIVE)">
      Désactiver toutes
    </button>
    <button type="button" class="quick-action-btn" (click)="resetForm()">Réinitialiser</button>
  </div>
</div>

<!-- Empty State -->
<div *ngIf="!loading && !error && availableFeatures.length === 0" class="empty-state">
  <div class="empty-icon">🔧</div>
  <h3>Aucune fonctionnalité disponible</h3>
  <p>Aucune fonctionnalité n'est configurée pour cette application.</p>
</div>

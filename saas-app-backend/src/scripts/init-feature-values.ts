/**
 * Script d'initialisation des valeurs de fonctionnalit√©s par d√©faut
 * Impl√©mente le syst√®me de fonctionnalit√©s configurables pour les applications SaaS
 * comme demand√©: Free: 10 emails, Premium: 200 emails, Enterprise: unlimited
 */
import { NestFactory } from '@nestjs/core';
import { AppModule } from '../app.module';
import { SaasFeatureValueService } from '../services/featureValue/saas-feature-value.service';
import { BulkCreateFeatureValuesDto } from '../services/dto/saas-feature-value.dto';
import {
  FeatureType,
  FeatureUnit,
} from '../data/models/saasFeatureValue/saasFeatureValue.pojo.model';

async function initializeFeatureValues() {
  const app = await NestFactory.createApplicationContext(AppModule);
  const featureValueService = app.get(SaasFeatureValueService);

  console.log('üöÄ Initialisation des valeurs de fonctionnalit√©s par d√©faut...');

  // Configuration exemple pour une application SaaS fictive
  // ID d'application et plans fictifs - √† remplacer par de vraies valeurs de votre DB
  const sampleApplicationId = '60d5f2c4e1a2c1b1f8d6e4f7'; // Remplacer par un vrai ID
  const planIds = {
    free: '60d5f2c4e1a2c1b1f8d6e4f8', // Plan gratuit
    premium: '60d5f2c4e1a2c1b1f8d6e4f9', // Plan premium
    enterprise: '60d5f2c4e1a2c1b1f8d6e4fa', // Plan entreprise
  };

  try {
    // 1. Configuration des emails par mois selon votre sp√©cification
    const emailFeatures: BulkCreateFeatureValuesDto = {
      featureValues: [
        {
          featureName: 'Emails par mois',
          description: "Nombre d'emails pouvant √™tre envoy√©s par mois",
          featureType: FeatureType.LIMIT,
          unit: FeatureUnit.EMAILS,
          value: 10,
          saasPlanId: planIds.free,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 1,
        },
        {
          featureName: 'Emails par mois',
          description: "Nombre d'emails pouvant √™tre envoy√©s par mois",
          featureType: FeatureType.LIMIT,
          unit: FeatureUnit.EMAILS,
          value: 200,
          saasPlanId: planIds.premium,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 1,
        },
        {
          featureName: 'Emails par mois',
          description: "Nombre d'emails pouvant √™tre envoy√©s par mois",
          featureType: FeatureType.LIMIT,
          unit: FeatureUnit.UNLIMITED,
          value: -1, // Valeur conventionnelle pour illimit√©
          saasPlanId: planIds.enterprise,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 1,
        },
      ],
    };

    // 2. Configuration de l'espace de stockage
    const storageFeatures: BulkCreateFeatureValuesDto = {
      featureValues: [
        {
          featureName: 'Espace de stockage',
          description: 'Espace de stockage disponible',
          featureType: FeatureType.QUOTA,
          unit: FeatureUnit.GIGABYTES,
          value: 1, // 1 GB pour le plan gratuit
          saasPlanId: planIds.free,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 2,
        },
        {
          featureName: 'Espace de stockage',
          description: 'Espace de stockage disponible',
          featureType: FeatureType.QUOTA,
          unit: FeatureUnit.GIGABYTES,
          value: 50, // 50 GB pour le plan premium
          saasPlanId: planIds.premium,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 2,
        },
        {
          featureName: 'Espace de stockage',
          description: 'Espace de stockage disponible',
          featureType: FeatureType.QUOTA,
          unit: FeatureUnit.UNLIMITED,
          value: -1, // Illimit√© pour l'entreprise
          saasPlanId: planIds.enterprise,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 2,
        },
      ],
    };

    // 3. Configuration du nombre d'utilisateurs
    const userFeatures: BulkCreateFeatureValuesDto = {
      featureValues: [
        {
          featureName: 'Utilisateurs',
          description: "Nombre d'utilisateurs pouvant acc√©der √† l'application",
          featureType: FeatureType.LIMIT,
          unit: FeatureUnit.USERS,
          value: 1, // 1 utilisateur pour le plan gratuit
          saasPlanId: planIds.free,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 3,
        },
        {
          featureName: 'Utilisateurs',
          description: "Nombre d'utilisateurs pouvant acc√©der √† l'application",
          featureType: FeatureType.LIMIT,
          unit: FeatureUnit.USERS,
          value: 10, // 10 utilisateurs pour le plan premium
          saasPlanId: planIds.premium,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 3,
        },
        {
          featureName: 'Utilisateurs',
          description: "Nombre d'utilisateurs pouvant acc√©der √† l'application",
          featureType: FeatureType.LIMIT,
          unit: FeatureUnit.UNLIMITED,
          value: -1, // Utilisateurs illimit√©s pour l'entreprise
          saasPlanId: planIds.enterprise,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 3,
        },
      ],
    };

    // 4. Configuration des fonctionnalit√©s d'acc√®s (Boolean)
    const accessFeatures: BulkCreateFeatureValuesDto = {
      featureValues: [
        {
          featureName: 'Support prioritaire',
          description: 'Acc√®s au support prioritaire',
          featureType: FeatureType.BOOLEAN,
          unit: FeatureUnit.COUNT,
          value: 0, // D√©sactiv√© pour le plan gratuit
          saasPlanId: planIds.free,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 4,
        },
        {
          featureName: 'Support prioritaire',
          description: 'Acc√®s au support prioritaire',
          featureType: FeatureType.BOOLEAN,
          unit: FeatureUnit.COUNT,
          value: 1, // Activ√© pour le plan premium
          saasPlanId: planIds.premium,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 4,
        },
        {
          featureName: 'Support prioritaire',
          description: 'Acc√®s au support prioritaire',
          featureType: FeatureType.BOOLEAN,
          unit: FeatureUnit.COUNT,
          value: 1, // Activ√© pour l'entreprise
          saasPlanId: planIds.enterprise,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 4,
        },
        {
          featureName: 'API Access',
          description: "Acc√®s √† l'API avanc√©e",
          featureType: FeatureType.BOOLEAN,
          unit: FeatureUnit.COUNT,
          value: 0, // D√©sactiv√© pour le plan gratuit
          saasPlanId: planIds.free,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 5,
        },
        {
          featureName: 'API Access',
          description: "Acc√®s √† l'API avanc√©e",
          featureType: FeatureType.BOOLEAN,
          unit: FeatureUnit.COUNT,
          value: 0, // D√©sactiv√© pour le plan premium
          saasPlanId: planIds.premium,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 5,
        },
        {
          featureName: 'API Access',
          description: "Acc√®s √† l'API avanc√©e",
          featureType: FeatureType.BOOLEAN,
          unit: FeatureUnit.COUNT,
          value: 1, // Activ√© uniquement pour l'entreprise
          saasPlanId: planIds.enterprise,
          saasApplicationId: sampleApplicationId,
          isActive: true,
          sortOrder: 5,
        },
      ],
    };

    // Initialisation en lot
    console.log("üìß Cr√©ation des fonctionnalit√©s d'emails...");
    const emailResults = await featureValueService.bulkCreateFeatureValues(emailFeatures);
    console.log(`‚úÖ ${emailResults.length} fonctionnalit√©s d'emails cr√©√©es`);

    console.log('üíæ Cr√©ation des fonctionnalit√©s de stockage...');
    const storageResults = await featureValueService.bulkCreateFeatureValues(storageFeatures);
    console.log(`‚úÖ ${storageResults.length} fonctionnalit√©s de stockage cr√©√©es`);

    console.log("üë• Cr√©ation des fonctionnalit√©s d'utilisateurs...");
    const userResults = await featureValueService.bulkCreateFeatureValues(userFeatures);
    console.log(`‚úÖ ${userResults.length} fonctionnalit√©s d'utilisateurs cr√©√©es`);

    console.log("üîí Cr√©ation des fonctionnalit√©s d'acc√®s...");
    const accessResults = await featureValueService.bulkCreateFeatureValues(accessFeatures);
    console.log(`‚úÖ ${accessResults.length} fonctionnalit√©s d'acc√®s cr√©√©es`);

    // Affichage du r√©sum√©
    const totalFeatures =
      emailResults.length + storageResults.length + userResults.length + accessResults.length;
    console.log(`\nüéâ Initialisation termin√©e ! ${totalFeatures} fonctionnalit√©s cr√©√©es au total`);

    console.log('\nüìã R√©sum√© des configurations par plan:');
    console.log('FREE PLAN:');
    console.log('  - 10 emails par mois');
    console.log('  - 1 GB de stockage');
    console.log('  - 1 utilisateur');
    console.log('  - Support standard');
    console.log("  - Pas d'acc√®s API");

    console.log('\nPREMIUM PLAN:');
    console.log('  - 200 emails par mois');
    console.log('  - 50 GB de stockage');
    console.log('  - 10 utilisateurs');
    console.log('  - Support prioritaire');
    console.log("  - Pas d'acc√®s API");

    console.log('\nENTERPRISE PLAN:');
    console.log('  - Emails illimit√©s');
    console.log('  - Stockage illimit√©');
    console.log('  - Utilisateurs illimit√©s');
    console.log('  - Support prioritaire');
    console.log('  - Acc√®s API complet');
  } catch (error) {
    console.error("‚ùå Erreur lors de l'initialisation:", error);
  } finally {
    await app.close();
  }
}

// Ex√©cution du script
if (require.main === module) {
  initializeFeatureValues()
    .then(() => {
      console.log("\n‚ú® Script d'initialisation termin√© avec succ√®s");
      process.exit(0);
    })
    .catch((error) => {
      console.error('üí• Erreur fatale:', error);
      process.exit(1);
    });
}

export default initializeFeatureValues;

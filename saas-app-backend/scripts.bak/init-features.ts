import { NestFactory } from '@nestjs/core';
import { AppModule } from '../src/app.module';
import { FeatureService } from '../src/services/feature/feature.service';
import { FeatureMigrationService } from '../src/services/featureMigration/featureMigration.service';
import {
  FeatureCategory,
  FeatureStatus,
  FieldType,
} from '../src/data/entities/feature/feature.pojo.model';

/**
 * Script to initialize default features and migrate existing data
 */
async function initializeFeatures() {
  const app = await NestFactory.createApplicationContext(AppModule);

  try {
    const featureService = app.get(FeatureService);
    const migrationService = app.get(FeatureMigrationService);

    console.log('üöÄ Starting feature initialization...');

    // Define default global features
    const defaultFeatures = [
      // Core Features
      {
        name: 'user-management',
        description: 'Gestion des utilisateurs et des r√¥les',
        category: FeatureCategory.CORE,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'maxUsers',
            displayName: "Nombre maximum d'utilisateurs",
            description: "Limite du nombre d'utilisateurs actifs",
            fieldType: FieldType.NUMBER,
            isRequired: true,
            defaultValue: '10',
            validation: {
              min: 1,
              max: 10000,
              helpText: 'Entre 1 et 10,000 utilisateurs',
            },
          },
          {
            fieldName: 'roleBasedAccess',
            displayName: "Contr√¥le d'acc√®s bas√© sur les r√¥les",
            description: 'Activer la gestion des permissions par r√¥le',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'true',
          },
        ],
      },
      {
        name: 'data-storage',
        description: 'Stockage et gestion des donn√©es',
        category: FeatureCategory.CORE,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'storageLimit',
            displayName: 'Limite de stockage (GB)',
            description: 'Espace de stockage maximum autoris√©',
            fieldType: FieldType.NUMBER,
            isRequired: true,
            defaultValue: '5',
            validation: {
              min: 1,
              max: 1000,
              helpText: 'Entre 1 GB et 1 TB',
            },
          },
          {
            fieldName: 'backupEnabled',
            displayName: 'Sauvegardes automatiques',
            description: 'Activer les sauvegardes automatiques',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
        ],
      },
      {
        name: 'basic-support',
        description: 'Support client de base',
        category: FeatureCategory.CORE,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'supportChannels',
            displayName: 'Canaux de support',
            description: 'Types de support disponibles (email, chat, phone)',
            fieldType: FieldType.TEXT,
            isRequired: false,
            defaultValue: 'email',
          },
          {
            fieldName: 'responseTime',
            displayName: 'Temps de r√©ponse (heures)',
            description: 'Temps de r√©ponse maximum garanti',
            fieldType: FieldType.NUMBER,
            isRequired: false,
            defaultValue: '48',
            validation: {
              min: 1,
              max: 168,
            },
          },
        ],
      },

      // Advanced Features
      {
        name: 'advanced-analytics',
        description: 'Analyses et rapports avanc√©s',
        category: FeatureCategory.ADVANCED,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'reportTypes',
            displayName: 'Types de rapports',
            description: 'Types de rapports disponibles',
            fieldType: FieldType.TEXT,
            isRequired: false,
            defaultValue: 'basic,advanced',
          },
          {
            fieldName: 'realTimeData',
            displayName: 'Donn√©es en temps r√©el',
            description: 'Acc√®s aux donn√©es en temps r√©el',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
          {
            fieldName: 'dataRetention',
            displayName: 'R√©tention des donn√©es (jours)',
            description: 'Dur√©e de conservation des donn√©es analytiques',
            fieldType: FieldType.NUMBER,
            isRequired: false,
            defaultValue: '90',
            validation: {
              min: 30,
              max: 2555,
            },
          },
        ],
      },
      {
        name: 'workflow-automation',
        description: 'Automatisation des processus m√©tier',
        category: FeatureCategory.ADVANCED,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'maxWorkflows',
            displayName: 'Nombre maximum de workflows',
            description: 'Limite du nombre de workflows actifs',
            fieldType: FieldType.NUMBER,
            isRequired: true,
            defaultValue: '5',
            validation: {
              min: 1,
              max: 100,
            },
          },
          {
            fieldName: 'complexWorkflows',
            displayName: 'Workflows complexes',
            description: 'Autoriser les workflows avec conditions multiples',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
        ],
      },
      {
        name: 'api-access',
        description: 'Acc√®s API REST et webhooks',
        category: FeatureCategory.ADVANCED,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'apiCallsLimit',
            displayName: "Limite d'appels API par mois",
            description: "Nombre maximum d'appels API autoris√©s",
            fieldType: FieldType.NUMBER,
            isRequired: true,
            defaultValue: '1000',
            validation: {
              min: 100,
              max: 1000000,
            },
          },
          {
            fieldName: 'webhooksEnabled',
            displayName: 'Webhooks',
            description: 'Activer les notifications webhook',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
          {
            fieldName: 'rateLimitBypass',
            displayName: 'Bypass des limites de taux',
            description: 'Autoriser le d√©passement temporaire des limites',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
        ],
      },

      // Premium Features
      {
        name: 'white-label',
        description: 'Personnalisation de marque compl√®te',
        category: FeatureCategory.PREMIUM,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'customDomain',
            displayName: 'Domaine personnalis√©',
            description: "Autoriser l'utilisation d'un domaine personnalis√©",
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
          {
            fieldName: 'customStyling',
            displayName: 'Styles personnalis√©s',
            description: 'Personnalisation compl√®te des styles CSS',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
          {
            fieldName: 'brandingRemoval',
            displayName: 'Suppression du branding',
            description: 'Supprimer compl√®tement le branding de la plateforme',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
        ],
      },
      {
        name: 'enterprise-security',
        description: 'S√©curit√© de niveau entreprise',
        category: FeatureCategory.PREMIUM,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'ssoEnabled',
            displayName: 'Single Sign-On (SSO)',
            description: "Activer l'authentification SSO",
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
          {
            fieldName: 'mfaRequired',
            displayName: 'Authentification multi-facteurs obligatoire',
            description: 'Rendre la MFA obligatoire pour tous les utilisateurs',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
          {
            fieldName: 'auditLogging',
            displayName: "Journalisation d'audit",
            description: 'Logs d√©taill√©s de toutes les actions',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
          {
            fieldName: 'dataEncryption',
            displayName: 'Chiffrement des donn√©es',
            description: 'Niveau de chiffrement des donn√©es',
            fieldType: FieldType.TEXT,
            isRequired: false,
            defaultValue: 'standard',
            validation: {
              helpText: 'Options: standard, enhanced, enterprise',
            },
          },
        ],
      },
      {
        name: 'priority-support',
        description: 'Support prioritaire 24/7',
        category: FeatureCategory.PREMIUM,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'dedicatedManager',
            displayName: 'Gestionnaire d√©di√©',
            description: "Attribution d'un gestionnaire de compte d√©di√©",
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
          {
            fieldName: 'phoneSupport',
            displayName: 'Support t√©l√©phonique',
            description: 'Acc√®s au support par t√©l√©phone',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
          {
            fieldName: 'emergencyResponse',
            displayName: "R√©ponse d'urgence (minutes)",
            description: 'Temps de r√©ponse pour les urgences',
            fieldType: FieldType.NUMBER,
            isRequired: false,
            defaultValue: '30',
            validation: {
              min: 5,
              max: 120,
            },
          },
        ],
      },

      // Add-on Features
      {
        name: 'advanced-integrations',
        description: 'Int√©grations tierces avanc√©es',
        category: FeatureCategory.ADDON,
        isGlobal: true,
        status: FeatureStatus.ACTIVE,
        customFields: [
          {
            fieldName: 'maxIntegrations',
            displayName: "Nombre maximum d'int√©grations",
            description: "Limite du nombre d'int√©grations actives",
            fieldType: FieldType.NUMBER,
            isRequired: true,
            defaultValue: '3',
            validation: {
              min: 1,
              max: 50,
            },
          },
          {
            fieldName: 'customIntegrations',
            displayName: 'Int√©grations personnalis√©es',
            description: 'Autoriser les int√©grations personnalis√©es',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
        ],
      },
      {
        name: 'mobile-app',
        description: 'Application mobile native',
        category: FeatureCategory.ADDON,
        isGlobal: true,
        status: FeatureStatus.COMING_SOON,
        customFields: [
          {
            fieldName: 'platforms',
            displayName: 'Plateformes support√©es',
            description: 'Plateformes mobiles disponibles',
            fieldType: FieldType.TEXT,
            isRequired: false,
            defaultValue: 'ios,android',
          },
          {
            fieldName: 'offlineMode',
            displayName: 'Mode hors ligne',
            description: 'Fonctionnalit√©s disponibles hors ligne',
            fieldType: FieldType.BOOLEAN,
            isRequired: false,
            defaultValue: 'false',
          },
        ],
      },
    ];

    // Create default features
    console.log('üìã Creating default features...');
    for (const featureData of defaultFeatures) {
      try {
        // Check if feature already exists
        const existing = await featureService.findOne({
          name: featureData.name,
          isGlobal: true,
        });

        if (!existing) {
          const feature = await featureService.create(featureData);
          console.log(`‚úÖ Created feature: ${feature.name}`);
        } else {
          console.log(`‚è≠Ô∏è  Feature already exists: ${featureData.name}`);
        }
      } catch (error) {
        console.error(`‚ùå Error creating feature ${featureData.name}:`, error.message);
      }
    }

    // Run migration to update existing plans
    console.log('üîÑ Running migration for existing plans...');
    try {
      await migrationService.migratePlansToNewFeatureSystem();
      console.log('‚úÖ Migration completed successfully');
    } catch (error) {
      console.error('‚ùå Migration failed:', error.message);
    }

    console.log('üéâ Feature initialization completed!');
  } catch (error) {
    console.error('üí• Fatal error during initialization:', error);
    process.exit(1);
  } finally {
    await app.close();
  }
}

// Run the script
if (require.main === module) {
  initializeFeatures()
    .then(() => {
      console.log('‚ú® All done!');
      process.exit(0);
    })
    .catch((error) => {
      console.error('üí• Script failed:', error);
      process.exit(1);
    });
}

export { initializeFeatures };
